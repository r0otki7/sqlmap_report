#!/bin/bash
#************************************************************
#sqlmap_report: An automated report creator for sqlmap.
#************************************************************
#Written by r0otki7 <https://github.com/r0otki7/>
#************************************************************

echo "*************************************************************************************"
echo "				Automated sqlmap report creator"
echo "*************************************************************************************"
read -p "Enter the project name: (A directory in the $HOME folder will be created and the results will be stored there): " project
if [[ ! -d "$project" ]]
then
	mkdir -p "$project"
else
	read -p "Folder exists, wanna delete it and create new one? (y/n): " opto
	case $opto in 
	"y" | "Y")
		rm -rf "$HOME/$project/"
		mkdir -p "$HOME/$project/"
		echo "Folder created"
	;;
	"n" | "N")
		echo "Folder intact"
	;;
	*)
		echo "enter y or n only"
		exit
		;;
	esac 
fi
function cmprs {
	if [[ ! -f "$HOME/$project/overview_sqlmap_$project.txt" ]]
	then
		echo "Scan not Started, Exiting....."
		rm -rf "$HOME/$project/"
	else
		echo "*************************************************************************************"
		echo "					Scan Completed"
		echo "*************************************************************************************"
		echo "Creating report in $HOME/$project"
		python $HOME/custom_scripts/sqlmap_report.py $HOME/$project/overview_sqlmap_$project.txt
		echo "*************************************************************************************"
		echo "				Starting compression and creating the zip."
		echo "*************************************************************************************"
		mv $HOME/$project/overview_sqlmap_$project.txt.html $HOME/$project/overview_sqlmap_$project.html
		zip -j -9 $HOME/$project/sqlmap_results_$project.zip $HOME/$project/overview_sqlmap_$project.html $HOME/$project/extensive_sqlmap_$project.txt
		echo "*************************************************************************************"
		echo "				Zipping done, enjoy!!"
		echo "*************************************************************************************"
	fi
	exit 2
}
trap cmprs 2
read -p "Enter if you want to read from an URL or a file (u/f): " option
case $option in
	"u" | "U")
		echo "*************************************************************************************"
		echo "					URL Selected"
		echo "*************************************************************************************"
		read -p "Enter the URL with params: " url
		read -p "Enter the number of threads (max 10): " thrd
		if [[ $thrd -gt 10 ]]
		then
			echo "Enter max 10 threads"
			exit
		fi
		read -p "Enter the level (max 5): " level
		if [[ $level -gt 5 ]]
        then
            echo "Enter max 5 level"
            exit
        fi
		read -p "Enter the risk (max 3): " risk
		if [[ $risk -gt 3 ]]
        then
            echo "Enter max 3 risk"
            exit
		fi
		read -p "Enter the cookie value: " cookie
		read -p "Enter the Backend (MySQL, MSSQL, Oracle etc): " dbms
		echo "*************************************************************************************"
		echo "					Scan Started"
		echo "*************************************************************************************"
		sqlmap -u "$url" --threads=$thrd --level=$level --risk=$risk --cookie="$cookie" -f --banner --dbs --dbms="$dbms" -s "$HOME/$project/report_sqlmap_$project.sqlite" --flush-session -t "$HOME/$project/extensive_sqlmap_$project.txt" --fresh-queries 2>&1 | tee "$HOME/$project/overview_sqlmap_$project.txt"

		cmprs
;;
	"f" | "F")
		echo "*************************************************************************************"
		echo "					File Selected"
		echo "*************************************************************************************"
		read -p "Enter the filename in home directory: " filename
		if [[ ! -f "$HOME/$filename" ]]
		then
			echo "File does not exist, make sure you have entered correct filename and it is in $HOME directory."
			exit
		else
			read -p "Enter the number of threads (max 10): " thrd
            if [[ $thrd -gt 10 ]]
            then
                echo "Enter max 10 threads"
                exit
            fi
            read -p "Enter the level (max 5): " level
            if [[ $level -gt 5 ]]
            then
                echo "Enter max 5 level"
                exit
            fi
            read -p "Enter the risk (max 3): " risk
            if [[ $risk -gt 3 ]]
            then
                echo "Enter max 3 risk"
                exit
            fi
            read -p "Enter the Backend (MySQL, MSSQL, Oracle etc): " dbms
			echo "Scan started"
			sqlmap -r "$HOME/$filename" --threads=$thrd --level=$level --risk=$risk -f --banner --dbs --dbms="$dbms" -s "$HOME/$project/report_sqlmap_$project.sqlite" --flush-session -t "$HOME/$project/extensive_sqlmap_$project.txt" --fresh-queries 2>&1 | tee "$HOME/$project/overview_sqlmap_$project.txt"
			cmprs
		fi
;;
	*) 
		echo "*************************************************************************************"
		echo "					Enter only u or f"
		echo "*************************************************************************************"
		exit
;;
esac